<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Invitation Flow Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; }
        .step { margin: 15px 0; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        input, select { width: 300px; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        .form-group { margin: 10px 0; }
        label { display: inline-block; width: 150px; font-weight: bold; }
        .url-section { background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .url-link { color: #007bff; text-decoration: none; word-break: break-all; }
        .url-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Enhanced Team Invitation Flow Test</h1>
        <p>Test the complete invitation workflow with temporary passwords, role-based routing, and profile setup.</p>

        <!-- Step 1: Send Invitation -->
        <div class="test-section">
            <h2>üìß Step 1: Send Team Invitation</h2>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="inviteEmail" value="john.doe@testdealership.com" />
            </div>
            <div class="form-group">
                <label>Role:</label>
                <select id="inviteRole">
                    <option value="sales_representative">Sales Representative</option>
                    <option value="sales_manager">Sales Manager</option>
                    <option value="owner">Owner</option>
                </select>
            </div>
            <div class="form-group">
                <label>Organization:</label>
                <input type="text" id="orgName" value="Premier Auto Group" />
            </div>
            <div class="form-group">
                <label>Inviter Name:</label>
                <input type="text" id="inviterName" value="Sarah Johnson" />
            </div>
            <button onclick="sendInvitation()">Send Invitation</button>
            <div id="inviteResult" class="result" style="display: none;"></div>
        </div>

        <!-- Step 2: Test Invite URLs -->
        <div class="test-section" id="urlSection" style="display: none;">
            <h2>üîó Step 2: Generated URLs</h2>
            <div class="url-section">
                <strong>üìß Invitation Email URL:</strong><br>
                <a id="inviteUrl" class="url-link" target="_blank"></a>
            </div>
            <div class="url-section">
                <strong>üîë Manual Login Test:</strong><br>
                <p>Email: <span id="testEmail"></span></p>
                <p>Temporary Password: <span id="tempPassword" style="background: yellow; padding: 2px 5px; border-radius: 3px;"></span></p>
            </div>
        </div>

        <!-- Step 3: Test Authentication Flow -->
        <div class="test-section">
            <h2>üîê Step 3: Test Authentication</h2>
            <div class="form-group">
                <label>Token:</label>
                <input type="text" id="authToken" placeholder="Paste invite token here" />
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="authEmail" />
            </div>
            <div class="form-group">
                <label>Temp Password:</label>
                <input type="password" id="authPassword" />
            </div>
            <button onclick="testAuthentication()">Test Temp Password Login</button>
            <div id="authResult" class="result" style="display: none;"></div>
        </div>

        <!-- Step 4: Test Profile Completion -->
        <div class="test-section" id="profileSection" style="display: none;">
            <h2>üë§ Step 4: Complete Profile Setup</h2>
            <div class="form-group">
                <label>First Name:</label>
                <input type="text" id="firstName" value="John" />
            </div>
            <div class="form-group">
                <label>Last Name:</label>
                <input type="text" id="lastName" value="Doe" />
            </div>
            <div class="form-group">
                <label>Phone:</label>
                <input type="tel" id="phone" value="555-123-4567" />
            </div>
            <div class="form-group">
                <label>New Password:</label>
                <input type="password" id="newPassword" value="SecurePassword123!" />
            </div>
            <button onclick="completeProfile()">Complete Profile</button>
            <div id="profileResult" class="result" style="display: none;"></div>
        </div>

        <!-- Test Results Summary -->
        <div class="test-section" id="summarySection" style="display: none;">
            <h2>üéâ Test Summary</h2>
            <div id="testSummary"></div>
        </div>
    </div>

    <script>
        let currentToken = '';
        let currentUserId = '';
        let testResults = [];

        async function sendInvitation() {
            const email = document.getElementById('inviteEmail').value;
            const role = document.getElementById('inviteRole').value;
            const organizationName = document.getElementById('orgName').value;
            const inviterName = document.getElementById('inviterName').value;

            if (!email) {
                showResult('inviteResult', 'Please enter an email address', 'error');
                return;
            }

            try {
                showResult('inviteResult', 'Sending invitation...', 'info');

                const response = await fetch('/api/team/invite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        role: role,
                        organizationName: organizationName,
                        inviterName: inviterName
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentToken = result.token;
                    showResult('inviteResult', `‚úÖ Invitation sent successfully!\n\nToken: ${result.token}\nTemporary Password: ${result.tempPassword}`, 'success');
                    
                    // Show URLs section
                    document.getElementById('urlSection').style.display = 'block';
                    document.getElementById('inviteUrl').href = `/tenant-login?subdomain=test&invite=${result.token}`;
                    document.getElementById('inviteUrl').textContent = `${window.location.origin}/tenant-login?subdomain=test&invite=${result.token}`;
                    document.getElementById('testEmail').textContent = email;
                    document.getElementById('tempPassword').textContent = result.tempPassword;
                    
                    // Auto-fill auth form
                    document.getElementById('authToken').value = result.token;
                    document.getElementById('authEmail').value = email;
                    document.getElementById('authPassword').value = result.tempPassword;
                    
                    testResults.push({ step: 'Send Invitation', status: 'success', message: 'Invitation sent with temporary password' });
                } else {
                    showResult('inviteResult', `‚ùå Failed to send invitation:\n${result.message}`, 'error');
                    testResults.push({ step: 'Send Invitation', status: 'error', message: result.message });
                }
            } catch (error) {
                showResult('inviteResult', `‚ùå Error sending invitation:\n${error.message}`, 'error');
                testResults.push({ step: 'Send Invitation', status: 'error', message: error.message });
            }
        }

        async function testAuthentication() {
            const token = document.getElementById('authToken').value;
            const email = document.getElementById('authEmail').value;
            const tempPassword = document.getElementById('authPassword').value;

            if (!token || !email || !tempPassword) {
                showResult('authResult', 'Please fill in all authentication fields', 'error');
                return;
            }

            try {
                showResult('authResult', 'Testing temporary password authentication...', 'info');

                const response = await fetch('/api/team/invite/accept', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        email: email,
                        tempPassword: tempPassword
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentUserId = result.userId;
                    showResult('authResult', `‚úÖ Authentication successful!\n\nUser ID: ${result.userId}\nUser Data: ${JSON.stringify(result.userData, null, 2)}`, 'success');
                    
                    // Show profile section
                    document.getElementById('profileSection').style.display = 'block';
                    
                    testResults.push({ step: 'Authentication', status: 'success', message: 'Temporary password accepted' });
                } else {
                    showResult('authResult', `‚ùå Authentication failed:\n${result.message}`, 'error');
                    testResults.push({ step: 'Authentication', status: 'error', message: result.message });
                }
            } catch (error) {
                showResult('authResult', `‚ùå Error during authentication:\n${error.message}`, 'error');
                testResults.push({ step: 'Authentication', status: 'error', message: error.message });
            }
        }

        async function completeProfile() {
            const token = document.getElementById('authToken').value;
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const phone = document.getElementById('phone').value;
            const newPassword = document.getElementById('newPassword').value;

            if (!token || !currentUserId || !firstName || !lastName || !phone || !newPassword) {
                showResult('profileResult', 'Please fill in all profile fields and complete authentication first', 'error');
                return;
            }

            try {
                showResult('profileResult', 'Completing profile setup...', 'info');

                const response = await fetch('/api/team/invite/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        userId: currentUserId,
                        firstName: firstName,
                        lastName: lastName,
                        phone: phone,
                        newPassword: newPassword
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showResult('profileResult', `‚úÖ Profile setup completed!\n\nUser: ${JSON.stringify(result.user, null, 2)}`, 'success');
                    
                    // Show summary
                    document.getElementById('summarySection').style.display = 'block';
                    testResults.push({ step: 'Profile Setup', status: 'success', message: 'Profile completed successfully' });
                    showTestSummary();
                } else {
                    showResult('profileResult', `‚ùå Profile setup failed:\n${result.message}`, 'error');
                    testResults.push({ step: 'Profile Setup', status: 'error', message: result.message });
                }
            } catch (error) {
                showResult('profileResult', `‚ùå Error completing profile:\n${error.message}`, 'error');
                testResults.push({ step: 'Profile Setup', status: 'error', message: error.message });
            }
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        function showTestSummary() {
            const summary = document.getElementById('testSummary');
            let html = '<h3>Enhanced Invitation Flow Test Results:</h3>';
            
            testResults.forEach(result => {
                const icon = result.status === 'success' ? '‚úÖ' : '‚ùå';
                html += `<div class="${result.status}">${icon} ${result.step}: ${result.message}</div>`;
            });

            const successCount = testResults.filter(r => r.status === 'success').length;
            const totalCount = testResults.length;
            
            html += `<br><strong>Overall Result: ${successCount}/${totalCount} steps completed successfully</strong>`;
            
            if (successCount === totalCount) {
                html += '<div class="success">üéâ All tests passed! Enhanced invitation flow is working correctly.</div>';
            } else {
                html += '<div class="error">‚ö†Ô∏è Some tests failed. Please check the implementation.</div>';
            }

            summary.innerHTML = html;
        }

        // Auto-run invitation test with pre-filled data
        console.log('Enhanced Invitation Flow Test Page Loaded');
        console.log('Click "Send Invitation" to start testing the complete flow');
    </script>
</body>
</html>